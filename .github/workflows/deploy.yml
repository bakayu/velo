name: Deploy to Azure

on:
  push:
    # TRIGGER CHANGE: Only run this workflow when a tag starting with 'v' is pushed
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Create a GitHub Release with a pretty changelog first
  create-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for git-cliff to read history

      - name: Generate Changelog
        uses: orhun/git-cliff-action@v3
        id: git-cliff
        with:
          config: cliff.toml
          args: -vv --latest --strip header
        env:
          OUTPUT: CHANGELOG.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.git-cliff.outputs.content }}
          prerelease: false

  # The Deployment Job (same as before, but waits for release creation)
  build-and-deploy:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push Docker image
        run: |
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/velo:${{ github.ref_name }} .
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/velo:${{ github.ref_name }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          # Deploy the specific tag we just built
          images: ${{ secrets.ACR_LOGIN_SERVER }}/velo:${{ github.ref_name }}